Концепция:
У нас есть Люди(класс такой), у каждого по аккаунту. Каждый получает задачу перевести деньги на другой акк базовую сумму. Босс получает задачу начислить всем аккаунтам по 1000. Начисляет через банк, где привязанны все аккаунты.

Перевод реализован тем, что вначале делается списание с одного аккаунта, потом перевод на другой (эта механика в классе TransferTest).
Причем вывод один из двух: обычный и предпочтительный через рандом.


Я сделал lock на предпочтительные отдельным, чтобы новые предпочтительные выводы не пытались захватить лок на баланс, а вначале увеличивали желание на вывод, даже если какой-то предпочтительный сейчас выводит.
Тогда не произойдет такого,что кто-то хотел вывести предпочтительным, но не успел захватить лок, поэтому вывел обычным.

Деадлока не должно произойти потому, что захват preferred лока с двумя локами происходит в строгой последовательности. Вначале захватывается lock на изменение баланса, потом на preferred для чтения или изменения.
Вывод одновременно с депозитом не произойдет, так как у нас на вывод средств или пополнение нужно захватить lock.

